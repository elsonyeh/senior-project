# SwiftTaste 推薦系統診斷報告

## 問題現象
未打亂順序時，推薦餐廳會：
1. 都是最新新增的餐廳
2. 按照新增順序顯示
3. 懷疑推薦系統未正常運作

## 根本原因分析

### 1. 資料載入順序
```javascript
// restaurantService.js: line 29
.order('created_at', { ascending: false })
```
- 餐廳從資料庫載入時，預設按 `created_at` **降序**排列
- **結果**：新增的餐廳在陣列最前面

### 2. 分數計算與排序
```javascript
// SwiftTaste.jsx: line 713-715
const sortedRestaurants = qualifiedRestaurants.length > 0 ?
  qualifiedRestaurants.sort((a, b) => b.calculatedScore - a.calculatedScore) :
  scoredRestaurants.sort((a, b) => b.calculatedScore - a.calculatedScore).slice(0, 10);
```

#### 關鍵問題：JavaScript sort() 的穩定性
- **JavaScript sort() 是穩定排序**：當兩個元素比較結果相等時（`b.calculatedScore - a.calculatedScore === 0`），會保持原始順序
- 如果很多餐廳分數相同，它們會保持載入時的順序（新→舊）

### 3. 為什麼分數會相同？

#### 分數計算公式：
```javascript
const WEIGHT = {
  BASIC_MATCH: 10,      // 基本匹配
  FUN_MATCH: 5,         // 趣味匹配
  RATING: 1.5,          // 評分權重
  MIN_SCORE: 1          // 最低分數
};
```

#### 典型場景：
假設用戶選擇：
- 基本問題：單人、平價美食、吃、吃飽、不辣
- 趣味問題：3個問題

**情況1：只有基本匹配的餐廳**
- 餐廳A：符合所有5個基本條件 = 10 × 5 + 5(獎勵) + 1.5(評分) = **56.5分**
- 餐廳B：符合所有5個基本條件 = 10 × 5 + 5(獎勵) + 1.2(評分) = **56.2分**
- 餐廳C：符合所有5個基本條件 = 10 × 5 + 5(獎勵) + 1.5(評分) = **56.5分**

**結果**：A 和 C 分數相同（56.5），會按原始順序排列

**情況2：趣味問題加成**
- 如果沒有趣味問題匹配標籤，很多餐廳的趣味分數都是 0
- 導致大量餐廳只有基本分數 + 評分
- 評分差異很小（1-5星 × 1.5 = 最多1.5分差距）

### 4. 隨機性的影響

#### Price Range 隨機匹配：
```javascript
case "奢華美食":
  matched = price_range === 3 || (price_range === 2 && Math.random() < 0.7);
```

**問題**：
- 每次計算分數時，`price_range === 2` 的餐廳有 70% 機率匹配
- 導致同一家餐廳每次推薦分數可能不同
- 但如果大部分餐廳都 `price_range === 2`，隨機結果可能讓很多餐廳同時符合或不符合

## 為什麼打亂可以解決問題？

打亂算法：
```javascript
const shuffled = [...topTen];
for (let i = shuffled.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
}
```

- **Fisher-Yates 洗牌**：確保每個排列的機率相同
- 即使分數完全相同，順序也會隨機
- 用戶體驗：每次看到不同的推薦順序

## 推薦系統是否正常運作？

### ✅ 推薦系統**確實在運作**，但有以下特點：

1. **嚴格過濾**：
   - 前置過濾：人數、價格、餐飲類型、辣度
   - 分數過濾：必須 > 0 且 >= MIN_SCORE (1分)

2. **分數計算正確**：
   - 基本匹配：每項 10 分
   - 趣味匹配：每項 5 分
   - 評分加成：最高 1.5 分
   - 完全匹配獎勵：5 分

3. **問題在於分數區分度不足**：
   - 基本條件相同的餐廳，分數差異主要來自評分（1.5分以內）
   - 趣味問題如果標籤不完整，很多餐廳趣味分為 0
   - 導致大量餐廳分數集中在同一區間

## 建議改進方案

### 選項1：增加分數區分度
```javascript
// 加入更多差異化因素
- 距離權重
- 人氣度權重（收藏數、點擊數）
- 新鮮度衰減（避免總是推薦新餐廳）
```

### 選項2：改進趣味問題標籤
- 確保每家餐廳都有足夠的標籤
- 提高趣味問題匹配的權重

### 選項3：維持現狀 + 打亂
- 接受「符合條件的餐廳分數相近」的現實
- 用打亂確保公平性
- **這是目前採用的方案**

## 結論

**推薦系統正常運作**，但因為：
1. 基本條件過濾後，剩餘餐廳的特徵相似
2. 趣味問題標籤覆蓋不完整
3. JavaScript 穩定排序保持原始順序

導致分數相同的餐廳按載入順序（新→舊）顯示。

**打亂算法**是合理的解決方案，確保：
- 分數相同時公平分配曝光機會
- 用戶體驗多樣化
- 不偏向新餐廳或舊餐廳
