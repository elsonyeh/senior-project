# 🌟 餐廳評分更新系統使用指南

## 📋 概述

本系統提供管理員一鍵更新所有餐廳的 Google Places 評分功能，有效控制 API 使用成本。

## 🎯 主要功能

### 1. 評分更新服務
- **智能搜尋**：使用餐廳名稱和地址在 Google Places 中搜尋
- **相似度匹配**：自動匹配最相符的餐廳
- **批次處理**：分批更新，避免 API 限制
- **成本控制**：設定更新頻率，避免重複更新

### 2. 管理員介面
- **統計資訊**：顯示餐廳總數、評分數量等統計
- **更新設定**：可調整批次大小、延遲時間等參數
- **進度監控**：即時顯示更新進度和結果
- **詳細報告**：提供完整的更新結果報告

## 🛠️ 使用方法

### 1. 進入管理後台
```
1. 前往 /admin 頁面
2. 使用管理員帳號登入
3. 點選「評分更新」標籤
```

### 2. 檢查統計資訊
查看四個主要統計：
- **總餐廳數**：資料庫中的餐廳總數
- **有評分**：已有評分的餐廳數量
- **有評分數**：有 Google 評分數的餐廳數量
- **近 7 天更新**：最近一週內更新過的餐廳數量

### 3. 調整更新設定
根據需求調整以下參數：

#### 批次大小
- **3 (安全)**：適合 API 配額較少的情況
- **5 (推薦)**：平衡速度與安全性
- **10 (快速)**：適合 API 配額充足的情況

#### 批次延遲
- **500ms (快)**：更新速度較快，但可能觸發限制
- **1s (推薦)**：平衡速度與穩定性
- **2s (安全)**：最穩定，但更新較慢

#### 更新週期
- **1 天**：每日更新，API 使用量較高
- **3 天**：平衡頻率與成本
- **7 天 (推薦)**：週期性更新，成本較低
- **30 天**：月度更新，最省成本

#### 強制更新
- **未勾選**：只更新過期的餐廳
- **已勾選**：更新所有餐廳（請謹慎使用）

### 4. 開始更新
1. 點選「開始更新評分」按鈕
2. 系統會顯示即時進度
3. 可隨時點選「停止更新」中斷處理
4. 更新完成後會顯示詳細結果

## 📊 數據結構

### 現有欄位
- `rating`：主要評分欄位（直接更新）
- `user_ratings_total`：評分數量
- `rating_updated_at`：最後更新時間

### 搜尋邏輯
1. **名稱匹配**：比較餐廳名稱相似度
2. **位置驗證**：確認距離在 1 公里內
3. **綜合評分**：名稱相似度 70% + 距離評分 30%
4. **最低門檻**：名稱相似度至少 60%

## 💰 成本控制策略

### 1. 更新頻率控制
- 使用 `rating_updated_at` 避免重複更新
- 設定合適的更新週期（建議 7 天）
- 避免強制更新所有餐廳

### 2. 批次處理優化
- 分批處理避免 API 限制
- 設定適當延遲時間
- 監控 API 配額使用情況

### 3. 智能過濾
- 只更新有基本資訊（名稱、座標）的餐廳
- 跳過近期已更新的餐廳
- 失敗重試機制

## 🔧 故障排除

### 常見錯誤

#### 1. Google Places API 不可用
```
錯誤：Google Places API 無法使用
解決：檢查 API 金鑰設定和配額
```

#### 2. 搜尋無結果
```
錯誤：無法在 Google Places 中找到此餐廳
原因：餐廳名稱或地址不準確
建議：檢查餐廳資料的準確性
```

#### 3. 配額超限
```
錯誤：OVER_QUERY_LIMIT
解決：調整批次大小和延遲時間，或增加 API 配額
```

### 檢查清單

#### 更新前
- [ ] 確認 Google Places API 可用
- [ ] 檢查 API 配額剩餘
- [ ] 設定合適的更新參數
- [ ] 確認餐廳資料品質

#### 更新後
- [ ] 檢查更新成功率
- [ ] 驗證評分資料準確性
- [ ] 監控 API 使用量
- [ ] 查看錯誤報告

## 📈 效果監控

### 統計指標
- **處理數量**：總共處理的餐廳數
- **更新成功**：成功更新評分的數量
- **跳過數量**：不需要更新的數量
- **失敗數量**：更新失敗的數量

### 詳細報告
系統會提供每個餐廳的詳細結果：
- **更新成功**：顯示舊評分 → 新評分
- **跳過原因**：說明為什麼跳過更新
- **失敗原因**：顯示具體錯誤訊息

## 🔄 定期維護

### 每週檢查
- 檢視評分更新統計
- 確認 API 使用量
- 檢查失敗案例

### 每月檢查
- 分析餐廳資料品質
- 調整更新策略
- 清理無效資料

## 📞 技術支援

如有任何問題，請檢查：
1. 瀏覽器開發者工具的錯誤訊息
2. 系統更新結果報告
3. Google Cloud Console 的 API 使用情況

---

*最後更新：2024年12月*